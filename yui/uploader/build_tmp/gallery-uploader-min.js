YUI.add("gallery-uploader",function(C){var V=C.ClassNameManager.getClassName,O="uploader",I="contentBox",X="label",R="hd",P="bd",L="ft",N="entry",E="fileAdded",K="fileRemoved",Z="filesChanged",F="resizeStart",J="resizeProgress",T="resizeComplete",W="archiveStart",B="archiveProgress",H="archiveComplete",U="uploadStart",A="uploadProgress",S="uploadResponse",G="uploadComplete",Q=1024*1024,D=[{service:"Uploader",version:"3",minversion:"3.2.12"},{service:"DragAndDrop",version:"2"},{service:"Directory",version:"2"},{service:"FileBrowse",version:"2"},{service:"ImageAlter",version:"4"},{service:"Archiver",version:"1"}];function M(Y){M.superclass.constructor.apply(this,arguments);}M.NAME=O;M.ATTRS={maxFileSize:{value:2*Q,validator:C.Lang.isNumber},resizeWidth:{value:0,validator:C.Lang.isNumber},resizeHeight:{value:0,validator:C.Lang.isNumber},resizeQuality:{value:80,validator:function(Y){return(C.Lang.isNumber(Y)&&Y>=0&&Y<=100);}},archiveFormat:{value:null,validator:function(Y){switch(Y){case"zip":case"zip-uncompressed":case"tar":case"tar-gzip":case"tar-bzip2":return true;default:return false;}}},mimeTypes:{value:[],validator:C.Lang.isArray},cookie:{value:null},files:{value:[],readOnly:true,validator:C.Lang.isArray},uploadUrl:{value:null},fieldName:{value:"file",validator:C.Lang.isString},vars:{value:null,validator:C.Lang.isObject},timeout:{value:240,validator:function(Y){return(C.Lang.isNumber(Y)&&Y>=3&&Y<=240);}},strings:{value:{filename:"File",size:"Size",close:"Close",add_files:"Add Files...",drop_files:"Drop Files",upload:"Upload",total:"Total:",size_b:" B",size_kb:" KB",size_mb:" MB",size_gb:" GB",size_tb:" TB",resize_progress:"Resizing Images",archive_progress:"Compressing Files",upload_progress:"Uploading Files",upload_complete:"Upload Complete!",first_text:"Press Add Files... or Drag and Drop files from your computer to start.",bp_download:'Please install <a target="blank" href="http://browserplus.yahoo.com/install/">BrowserPlus</a> to continue.',bp_installed:"Downloading services...  This happens just once.",bp_initfail:"Error - Could not start or install BrowserPlus.",bp_incompatible:"Error - Uploader is not compatible with this operating system or internet browser.",bp_requirefail:"Error - Could not fetch required services."}}};M.ENTRY_TEMPLATE='<div id="{str_guid}" class="{entry_class}">'+'<div class="{entry_name}">{str_name}</div>'+'<div class="{entry_size}">{str_size}</div>'+'<div class="{entry_action}"></div>'+"</div>";M.ENTRY_CSS={entry_class:V(O,N),entry_sel:V(O,N,"selected"),entry_name:V(O,N,"name"),entry_size:V(O,N,"size"),entry_action:V(O,N,"action")};M.HEADER_TEMPLATE='<div class="{hd_class} {bg_class}">'+'<div class="{hd_file_label}">{str_file}</div>'+'<div class="{hd_size_label}">{str_size}</div>'+'<div class="{hd_action_label}"></div>'+"</div>";M.HEADER_CSS={hd_class:V(O,R),bg_class:V(O,"bg"),hd_file_label:V(O,R,"file",X),hd_size_label:V(O,R,"size",X),hd_action_label:V(O,R,"action",X)};M.BODY_TEMPLATE="<div>"+'<div style="visibility:hidden" class="{bd_class} {hover_class}">'+'<div class="{hover_text}">{str_drop_files}</div>'+"</div>"+'<div id="{filelist_id}" class="{bd_class} {filelist_class}"></div>'+'<div style="visibility:visible" class="{bd_class} {first_class}">'+'<div class="{first_text}"></div>'+"</div>"+'<div style="visibility:hidden" class="{bd_class} {message_class}">'+'<div class="{message_text}"></div>'+'<div class="{message_close}"><a href="#">{str_close}</a></div>'+"</div>"+'<div style="visibility:hidden" class="{bd_class} {progress_class}">'+'<div class="{progress_bar} {progress_bg}"></div>'+'<div class="{progress_bar} {progress_fg}"></div>'+'<div class="{progress_text}">0%</div>'+'<div class="{progress_close}"><a href="#">{str_close}</a></div>'+"</div>"+"</div>";M.BODY_CSS={bd_class:V(O,P),hover_class:V(O,"hover"),hover_text:V(O,"hover","text"),filelist_class:V(O,"filelist"),first_class:V(O,"first"),first_text:V(O,"first","text"),message_class:V(O,"message"),message_text:V(O,"message","text"),message_close:V(O,"message","close"),progress_class:V(O,"progress"),progress_bar:V(O,"progress","bar"),progress_bg:V(O,"progress","bar","bg"),progress_fg:V(O,"progress","bar","fg"),progress_text:V(O,"progress","bar","text"),progress_close:V(O,"progress","close")};M.FOOTER_TEMPLATE='<div class="{ft_class} {bg_class}">'+'<div class="{ft_button_class}">'+'<button disabled class="{add_button}" type="button">{str_add_files}</button>'+'<button disabled class="{upload_button}" type="button">{str_upload}</button>'+"</div>"+'<div class="{ft_size_class}">'+'<span class="{ft_total_label}">{str_total}</span> '+'<span class="{ft_size_label}">{str_size}</span>'+"</div>"+"</div>";M.FOOTER_CSS={ft_class:V(O,L),bg_class:V(O,"bg"),ft_files_class:V(O,L,"files"),ft_button_class:V(O,L,"button"),ft_size_class:V(O,L,"size"),add_button:V(O,"button","add"),upload_button:V(O,"button","upload"),ft_size_label:V(O,L,"size",X),ft_total_label:V(O,L,"total",X)};C.extend(M,C.Widget,{_contentBox:null,_body:null,_foot:null,_filelist:null,_hoverpane:null,_showingHover:false,_showingFirst:false,_firstpane:null,_firsttext:null,_messagepane:null,_messagetext:null,_messageclose:null,_progresspane:null,_progressbar:null,_progresstext:null,_addbutton:null,_uploadbutton:null,_progressStrings:null,getFriendlySize:function(b){var a,Y=[this.get("strings.size_b"),this.get("strings.size_kb"),this.get("strings.size_mb"),this.get("strings.size_gb"),this.get("strings.size_tb")];for(a=0;b>1024;a++){b/=1024;}if(a<Y.length){return Math.round(b*10)/10+Y[a];}else{return"?";}},getSize:function(c){var a,b=0,Y=c.length;for(a=0;a<Y;a++){b+=c[a].size;}return b;},clearFiles:function(){var Y=this.get("files").length;this._filelist.all("."+M.ENTRY_CSS.entry_class).remove();this.get("files").splice(0,Y);this.fire(Z);},disableInput:function(Y){this.set("disabledInput",Y);this.enableAddButton(!Y);this.enableUploadButton(!Y&&this.get("files").length>0);},enableAddButton:function(Y){this._addbutton.set("disabled",!Y);},enableUploadButton:function(Y){this._uploadbutton.set("disabled",!Y||this.get("uploadUrl")===null);
},disable:function(){M.superclass.disable.call(this);this.disableInput(true);},enable:function(){M.superclass.enable.call(this);this.disableInput(false);},showMessage:function(Y){this.disableInput(true);this._messagetext.setContent(Y);this._progressclose.setStyle("visibility","hidden");this._progresspane.setStyle("visibility","hidden");this._messagepane.setStyle("visibility","visible");},hideMessage:function(){this.disableInput(false);this._messagepane.setStyle("visibility","hidden");},showFirst:function(Y){this._showingFirst=true;this._firsttext.setContent(Y);this._firstpane.setStyle("visibility","visible");},hideFirst:function(){this._showingFirst=false;this._firstpane.setStyle("visibility","hidden");},showHover:function(){this._showingHover=true;this._hoverpane.setStyle("visibility","visible");},hideHover:function(){this._showingHover=false;this._hoverpane.setStyle("visibility","hidden");},showProgress:function(){this.disableInput(true);this._progresstext.setContent("&nbsp;");this._progressbar.setStyle("width","0%");this._progressclose.setStyle("visibility","hidden");this._progresspane.setStyle("visibility","visible");},hideProgress:function(){this.disableInput(false);this._progressclose.setStyle("visibility","hidden");this._progresspane.setStyle("visibility","hidden");},setFileSize:function(Y){this._foot.one("."+M.FOOTER_CSS.ft_size_label).setContent(this.getFriendlySize(this.getSize(Y)));},_getFileIndex:function(c){var a,Y,b=this.get("files");for(a=0,Y=b.length;a<Y;a++){if(c===b[a].id){return a;}}return -1;},_getHandleIndex:function(c){var a,Y,b=this.get("files");for(a=0,Y=b.length;a<Y;a++){if(c===b[a].BrowserPlusHandleID){return a;}}return -1;},_addFilesToList:function(c){var a={files:c},Y=this.get("mimeTypes"),b=this;if(Y.length>0){a.mimetypes=this.get("mimeTypes");}YAHOO.bp.Directory.recursiveList(a,function(f){var e,d,g,h;if(!f.success){return;}h=b.get("maxFileSize");g=f.value.files;for(e=0;e<g.length;e++){d=g[e];if(b._getHandleIndex(d.BrowserPlusHandleID)===-1){if(d.mimeType[0]==="application/x-folder"){continue;}if(h<1||d.size<=h){d.id=C.guid().replace(/-/g,"_");b.fire(E,{file:d});}}}b.fire(Z);});},_fileAddedListener:function(a){this.get("files").push(a.file);var Y=C.merge(M.ENTRY_CSS,{str_guid:a.file.id,str_name:a.file.name,str_size:this.getFriendlySize(a.file.size)});this._filelist.append(C.substitute(M.ENTRY_TEMPLATE,Y));},_fileRemovedListener:function(a){var Y=this._getFileIndex(a.file.id);if(Y!==-1){this.get("files").splice(Y,1);C.one("#"+a.file.id).remove();}},_filesChangedListener:function(){var a=this.get("files"),Y=a.length;this.enableUploadButton(Y>0);this.setFileSize(a);},_progressListener:function(b){var a=b.progress.totalPercent,Y=b.type,c=this._progressStrings[Y];this._progresstext.setContent(c+": "+a+"%");this._progressbar.setStyle("width",a+"%");},_uploadStepComplete:function(Y){this.clearFiles();this._progresstext.setContent(this.get("strings.upload_complete"));this._progressclose.setStyle("visibility","visible");},_openFileDialog:function(a){if(this.get("disabledInput")){return;}var Y=this;if(this._showingFirst){this.hideFirst();}YAHOO.bp.FileBrowse.OpenBrowseDialog({},function(b){if(b.success){Y._addFilesToList(b.value.files);}});},_isImage:function(a){var Y;for(Y=0;Y<a.mimeType.length;Y++){switch(a.mimeType[Y]){case"image/gif":case"image/jpeg":case"image/pjpeg":case"image/png":return true;default:continue;}}return false;},_uploadStepButtonClicked:function(Y){this.fire(F,{files:this.get("files")});},_uploadStepResizeImages:function(l){var g,a=l.files,f=a.length,h=[],j=this,c,Y,p,o,b=this.get("resizeQuality"),k=this.get("resizeWidth"),d=this.get("resizeHeight"),n=0,m=0;this.showProgress();Y=function(e){return((k>0||d>0)&&j._isImage(e));};c=function(e,i){h.push(e);if(i){m++;o(e,100);}if(h.length===f){j.fire(T);j.fire(W,{files:h});}};p=function(i,e){YAHOO.bp.ImageAlter.transform({file:i,quality:b,actions:[{scale:{maxwidth:k,maxheight:d}}]},function(q){e((q.success?q.value.file:i),true);});};o=function(e,i){j.fire(J,{file:e,progress:{filePercent:i,totalPercent:Math.floor(m/n*100)}});};for(g=0;g<f;g++){if(Y(a[g])){n++;}}for(g=0;g<f;g++){if(Y(a[g])){o(a[g],0);p(a[g],c);}else{c(a[g],false);}}},_uploadStepArchiveFiles:function(c){var a=this,Y=c.files,b=this.get("archiveFormat");if(b){YAHOO.bp.Archiver.archive({files:Y,format:b,progressCallback:function(d){a.fire(B,{progress:{filePercent:d.percent,totalPercent:d.percent}});}},function(d){var e=(d.success?d.value.archiveFile:Y);a.fire(H);a.fire(U,{files:[e]});});}else{this.fire(H);this.fire(U,{files:Y});}},_uploadStepStart:function(h){var f,Y=h.files,d=Y.length,p=0,b=0,m={},o,g=this,l=this.get("uploadUrl"),n=this.get("fieldName"),k=this.get("timeout"),a=this.get("cookie"),j=this.get("vars"),c;b=this.getSize(Y);for(f=0;f<d;f++){m["id"+Y[f].BrowserPlusHandleID]=0;}c=function(e){return function(i){var r,q=0;m["id"+e.BrowserPlusHandleID]=i.fileSent;for(r in m){if(m.hasOwnProperty(r)){q+=m[r];}}g.fire(A,{file:e,progress:{fileSent:i.fileSent,fileSize:i.fileSize,filePercent:i.filePercent,totalSent:q,totalSize:b,totalPercent:Math.floor(q/b*100)}});};};o=function(i){var e={},q={};e[n]=i;q.url=l;q.files=e;q.timeout=k;q.progressCallback=c(i);if(j){q.postvars=j;}if(a){q.cookies=a;}YAHOO.bp.Uploader.upload(q,function(s){var t;if(s.success){t={statusCode:s.value.statusCode,statusString:s.value.statusString,headers:s.value.headers,body:s.value.body};}else{t={error:s.error,verboseError:s.verboseError};}g.fire(S,{response:{success:s.success,data:t}});if(++p==d){g.fire(G);}});};for(f=0;f<d;f++){o(Y[f]);}},_getNodeOrAncestorWithClass:function(Y,a){if(Y.get("className")===a){return Y;}else{return Y.ancestor(function(b){return(b.get("className")===a);});}},_fileClickEvent:function(b){if(this.get("disabledInput")){return;}var a=b.target,c=a.get("className"),Y;if(c===M.ENTRY_CSS.entry_action){a=this._getNodeOrAncestorWithClass(a,M.ENTRY_CSS.entry_class);if(a){b.preventDefault();Y=this._getFileIndex(a.get("id"));if(Y!=-1){this.fire(K,{file:this.get("files")[Y]});
this.fire(Z);}}}},initializer:function(Y){this.publish(E,{defaultFn:this._fileAddedListener});this.publish(K,{defaultFn:this._fileRemovedListener});this.publish(Z,{preventable:false,defaultFn:this._filesChangedListener});this.publish(F,{defaultFn:this._uploadStepResizeImages});this.publish(J,{preventable:false,defaultFn:this._progressListener});this.publish(T,{preventable:false});this.publish(W,{defaultFn:this._uploadStepArchiveFiles,preventedFn:this.hideProgress});this.publish(B,{preventable:false,defaultFn:this._progressListener});this.publish(H,{preventable:false});this.publish(U,{defaultFn:this._uploadStepStart,preventedFn:this.hideProgress});this.publish(A,{preventable:false,defaultFn:this._progressListener});this.publish(S,{preventable:false});this.publish(G,{defaultFn:this._uploadStepComplete});},destructor:function(){this._contentBox=null;this._body=null;this._foot=null;this._filelist=null;this._hoverpane=null;this._firstpane=null;this._firsttext=null;this._messagepane=null;this._messagetext=null;this._messageclose=null;this._progresspane=null;this._progressbar=null;this._progresstext=null;this._addbutton=null;this._uploadbutton=null;this._progressStrings=null;},renderUI:function(){this._contentBox=this.get(I);this._initHead();this._initBody();this._initFoot();},_initHead:function(){var a,Y=C.merge(M.HEADER_CSS,{str_file:this.get("strings.filename"),str_size:this.get("strings.size")});a=C.Node.create(C.substitute(M.HEADER_TEMPLATE,Y));this._contentBox.insertBefore(a,this._contentBox.get("firstChild"));},_initBody:function(){var a=C.guid(),Y=C.merge(M.BODY_CSS,{filelist_id:a,str_drop_files:this.get("strings.drop_files"),str_close:this.get("strings.close")});this._body=C.Node.create(C.substitute(M.BODY_TEMPLATE,Y));this._contentBox.appendChild(this._body);this._filelist=this._body.one("."+Y.filelist_class);this._hoverpane=this._body.one("."+Y.hover_class);this._firstpane=this._body.one("."+Y.first_class);this._firsttext=this._body.one("."+Y.first_text);this._messagepane=this._body.one("."+Y.message_class);this._messagetext=this._body.one("."+Y.message_text);this._messageclose=this._body.one("."+Y.message_close);this._progresspane=this._body.one("."+Y.progress_class);this._progressbar=this._body.one("."+Y.progress_fg);this._progresstext=this._body.one("."+Y.progress_text);this._progressclose=this._body.one("."+Y.progress_close);this._progressStrings={"uploader:resizeProgress":this.get("strings.resize_progress"),"uploader:archiveProgress":this.get("strings.archive_progress"),"uploader:uploadProgress":this.get("strings.upload_progress")};},_initFoot:function(){var Y=C.merge(M.FOOTER_CSS,{str_add_files:this.get("strings.add_files"),str_upload:this.get("strings.upload"),str_total:this.get("strings.total"),str_size:"0"+this.get("strings.size_b")});this._foot=C.Node.create(C.substitute(M.FOOTER_TEMPLATE,Y));this._contentBox.appendChild(this._foot);this._addbutton=this._foot.one("."+Y.add_button);this._uploadbutton=this._foot.one("."+Y.upload_button);},_binder:function(){var a=this._filelist.get("id"),Y=this;this._addbutton.on("click",this._openFileDialog,this);this._uploadbutton.on("click",this._uploadStepButtonClicked,this);this._messageclose.on("click",this.hideMessage,this);this._progressclose.on("click",this.hideProgress,this);this._filelist.on("click",this._fileClickEvent,this);this.showFirst(this.get("strings.first_text"));YAHOO.bp.DragAndDrop.AddDropTarget({id:a},function(b){if(!b.success){return;}YAHOO.bp.DragAndDrop.AttachCallbacks({id:a,hover:function(c){if(Y.get("disabledInput")){return;}if(Y._showingFirst){Y.hideFirst();}if(c&&!Y._showingHover){Y.showHover();}else{if(!c&&Y._showingHover){Y.hideHover();}}},drop:function(c){if(Y.get("disabledInput")){return;}Y.hideHover();Y._addFilesToList(c);}},function(){});});},_requireServices:function(){var Y=this;YAHOO.bp.require({services:D},function(a){if(a.success){Y.hideMessage();Y._binder();}else{Y._messageclose.setStyle("visibility","hidden");Y.showMessage(Y.get("strings.bp_requirefail"));}});},bindUI:function(){var Y=this;YAHOO.bp.init({},function(b){var a=YAHOO.bp.clientSystemInfo();if(b.success){Y._requireServices();}else{Y._messageclose.setStyle("visibility","hidden");if(a.supportLevel==="supported"&&(b.error==="bp.notInstalled"||b.error==="bpPlugin.platformBlacklisted")){Y.showMessage(Y.get("strings.bp_download"));YAHOO.bp.initWhenAvailable({},function(c){if(c.success){Y.showMessage(Y.get("strings.bp_installed"));Y._requireServices();}else{Y.showMessage(Y.get("strings.bp_initfail"));}});}else{Y.showMessage(Y.get("strings.bp_incompatible"));}}});}});C.Base.build(M.NAME,M,{dynamic:false});C.namespace("BP.Uploader");C.BP.Uploader=M;},"@VERSION@",{requires:["node","dom","classnamemanager","widget","event","substitute"]});